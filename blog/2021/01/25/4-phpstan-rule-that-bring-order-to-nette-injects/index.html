<!DOCTYPE html>
<html lang="en">
    <head>
    <title>4 PHPStan Rules that Bring Order to Nette Injects | Tomas Votruba</title>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    
    <link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/solid.css" integrity="sha384-wnAC7ln+XN0UKdcPvJvtqIH3jOjs9pnKnq9qX68ImXvOGz2JuFoEiCjT8jyZQX2z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/brands.css" integrity="sha384-nT8r1Kzllf71iZl81CdFzObMsaLOhqBU1JD2+XoAALbdtWaXDOlWOZTR4v1ktjPE" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/fontawesome.css" integrity="sha384-HbmWTHay9psM8qyzEKPc8odH4DsOuzdejtnr+OFtDmOcIVnhgReQ4GZBH7uwcjf6" crossorigin="anonymous">

        <link href="/assets/bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css" />

    <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />

        <link href="/assets/css/style.css" rel="stylesheet" type="text/css" />


        <link href="/assets/css/checklist.css" rel="stylesheet" type="text/css" />
</head>
    <body>
                <!-- post_id: 299 -->

        
<div class="hidden-sm-down">
    <nav class="navbar">
        <div class="container-fluid">
            <ul>
                <li id="logo">
                    <img src="https://avatars1.githubusercontent.com/u/924196?s=60&v=4" class="me_avatar">
                    Tomas Votruba
                </li>
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li class="">
                    <a href="/php-framework-trends">Trends</a>
                </li>
                <li class="">
                    <a href="/clusters">Clusters</a>
                </li>
                <li class="">
                    <a href="/projects">Projects</a>
                </li>
                <li class="">
                    <a href="/mission">Mission</a>
                </li>
                <li class="">
                    <a href="/contact">Contact</a>
                </li>
                <li id="top-menu-search">
                    <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="https://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="tomasvotruba.com" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
</form>
                </li>
            </ul>
        </div>
    </nav>
</div>

<div class="hidden-md-up">
    <nav class="navbar" id="mobile-menu">
        <div class="container">
            <a href="/" class="col-3 col-sm-3 active">
                <em class="fas fa-book"></em>
                <br>
                Blog
            </a>


            <a href="/clusters" class="col-3 col-sm-3 ">
                <em class="fas fa-share-alt"></em>
                <br>
                Clusters
            </a>

            <a href="/projects" class="col-3 col-sm-3 ">
                <em class="fas fa-chart-bar"></em>
                <br>
                Trends
            </a>

            <a href="/contact" class="col-3 col-sm-3 ">
                <em class="fas fa-phone"></em>
                <br>
                Contact
            </a>
        </div>
    </nav>

    <div class="hidden-md-up text-center" id="top-menu-search-mobile">
        <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="https://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="tomasvotruba.com" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
</form>
    </div>
</div>

        <div class="container-fluid" id="post">
            <h1>4 PHPStan Rules that Bring Order to Nette Injects</h1>

            <ul class="list-inline post-metadata">
    <li class="list-inline-item mr-3">
        <em class="fas fa-clock fa-fw"></em>
        <strong>4 min</strong>
    </li>

    <li class="list-inline-item mr-3">
        <em class="fas fa-calendar fa-fw"></em>
        <time datetime="2021-01-Mon">
            
                                            Mon, Jan 25
            
            </strike>        </time>
    </li>

    
            <li class="list-inline-item mr-3">
            <em class="fas fa-fw fa-comments"></em>
            <a href="/blog/2021/01/25/4-phpstan-rule-that-bring-order-to-nette-injects/#disqus_thread">X</a> comments
        </li>
    
    
            <li class="list-inline-item mr-3 text-primary">
            <em class="fab fa-fw fa-github"></em>
            <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/master/packages/blog/data/2021/2021-01-25-4-phpstan-rule-that-bring-order-to-nette-injects.md">Found a typo? Edit me</a>
        </li>
    </ul>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Do you have at least one <code>@inject</code> property or <code>inject*()</code> method in your Nette project? If no, stop reading and have fun with another post.
<br>
<br>
If you do, you probably have some internal rules where what and how to use them and where to avoid them. But how do you keep order?</p>
                </div>
            </div>

            <p>If you talk about your project's standards that everyone <em>should</em> follow, remember the old lazy programmer's saying:</p>
<blockquote class="blockquote text-center">
    "In CI,<br>
    or won't happen."
</blockquote>
<h2 id="injection-everywhere">Injection Everywhere?</h2>
<p>Using injection makes sense in some cases, like avoiding circular dependencies. Another use case is an abstract class with dozens of child classes, but mostly it's <a href="/blog/2020/06/01/inject-or-required-will-get-you-any-service-fast/">a killer for a healthy dependency tree</a>.</p>
<p>In a one <a href="https://nette.org/">Nette</a> project I worked on within the last five years, they had a very &quot;cool&quot; DI extension. A DI extension that enables <code>@inject</code> everywhere:</p>
<pre><code class="language-php">final class SomeClass
{
    /**
     * @var EventDispatcher
     * @inject
     */
    public $eventDispatcher;
}</code></pre>
<p>Why needs <code>__construct()</code>. right? Get PHP 8 promoted properties today.</p>
<blockquote class="blockquote text-center">
    "If it's not forbidden,<br>
    it's allowed."
</blockquote>
<p>Luckily, nowadays, we have a <a href="https://github.com/symplify/phpstan-rules">Symplify PHPStan rules</a> to help us.</p>
<h2 id="1-do-not-combine-nette-inject-and-code-construct-code">1. Do Not Combine Nette Inject and <code>__construct()</code></h2>
<p>If there is a constructor already, there an exact working way to get dependencies:</p>
<pre><code class="language-php">class SomeClass
{
    private $someType;

    private $anotherType;

    public function __construct(AnotherType $anotherType)
    {
        $this-&gt;anotherType = $anotherType;
        // ...
    }

    public function injectSomeType(SomeType $someType)
    {
        $this-&gt;someType = $someType;
    }
}</code></pre>
<p><em class="fas fa-fw fa-times text-danger fa-2x"></em></p>
<p><br></p>
<p>It's better to use far cleaner <code>__construct()</code> inection:</p>
<pre><code class="language-php">class SomeClass
{
    private $someType;

    private $anotherType;

    public function __construct(AnotherType $anotherType, SomeType $someType)
    {
        $this-&gt;anotherType = $anotherType;
        $this-&gt;someType = $someType;
    }
}</code></pre>
<p><em class="fas fa-fw fa-2x fa-check text-success"></em></p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\NoNetteInjectAndConstructorRule</code> rule.</p>
<p><br></p>
<h2 id="2-use-single-nette-code-inject-code-method">2. Use Single Nette <code>inject*()</code> Method</h2>
<p>Using the <code>inject*()</code> method is an equal alternative to <code>@inject</code> property that does not require a property to be public.
It like an extra <code>__construct()</code> that is caller by the framework to set other dependencies.</p>
<p>Single <code>__construct()</code> has its meaning. Imagine this use case:</p>
<pre><code class="language-php">class SomeClass
{
    private $type;

    private $anotherType;

    public function injectOne(SameType $type)
    {
        $this-&gt;type = $type;
    }

    public function injectTwo(SameType $anotherType)
    {
        $this-&gt;anotherType = $anotherType;
    }
}</code></pre>
<p><em class="fas fa-fw fa-times text-danger fa-2x"></em></p>
<p>Having multiple <code>inject*()</code> methods allow us to <strong>accidentally put two dependencies</strong> in the same class. This has performance hit, maintenance hit, and duplicated parasitic code that needs our attention for no gain.</p>
<p><br></p>
<p>We can solve all this with a single <code>inject*()</code> method per class:</p>
<pre><code class="language-php">class SomeClass
{
    private $someType;

    public function injectSomeClass(SomeType $someType)
    {
        $this-&gt;someType = $someType;
    }
}</code></pre>
<p><em class="fas fa-fw fa-2x fa-check text-success"></em></p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\SingleNetteInjectMethodRule</code> rule.</p>
<p><br></p>
<h2 id="3-validate-code-inject-code-format">3. Validate <code>@inject</code> Format</h2>
<p>I'm proud to admit I made this bug last week. With IDE autocomplete, class annotations, and PHP 8 attributes, I'm removing my skill to type precisely the word:</p>
<pre><code class="language-php">class SomeClass
{
    /**
     * @injects
     * @var SomeDependency
     */
    public  $someDependency;
}</code></pre>
<p>...and the property was <code>null</code>.</p>
<p><em class="fas fa-fw fa-times text-danger fa-2x"></em></p>
<p><br></p>
<p>Let's not do that ever again and validate <strong>letter by letter</strong> of <code>@inject</code> annotation:</p>
<pre><code class="language-diff"> class SomeClass
 {
     /**
-     * @injects
+     * @inject
      * @var SomeDependency
      */
     public $someDependency;
}</code></pre>
<p><em class="fas fa-fw fa-2x fa-check text-success"></em></p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\ValidNetteInjectRule </code> rule.</p>
<h2 id="4-no-code-inject-code-on-code-final-code-class">4. No <code>@inject</code> on <code>final</code> Class</h2>
<p>Last but not least, this rule finally put an order to our codebase.</p>
<p>A specific need for injects is an abstract class with a couple of children:</p>
<pre><code class="language-php">abstract class AbstractPresenter
{
}

final class ProductPresenter extends AbstractPresenter
{
}</code></pre>
<p><strong>Where would you allow injects?</strong></p>
<ul>
<li>in both classes</li>
<li>in children classes only</li>
<li>in abstract class only</li>
</ul>
<p><br></p>
<p>What would be the consequences:</p>
<ul>
<li><strong>In both classes?</strong> It's a mess that leads to injection hell. Would you get vaccinated against covid every week? No, so don't force your code to suffer either.</li>
<li><strong>In children classes only?</strong> Putting responsibility on every single child can be quite a challenge.</li>
<li><strong>In <code>abstract</code> class only?</strong> Well, a single parent with five children is quite a responsibility, but it's clear and one place to go in case of problems.</li>
</ul>
<p>The ideal options is 3). Using inject only abstract classes make children cleaner and less coupled to the framework. There are more children classes than abstract, so code base quality will be much higher if children classes are strict and clean.</p>
<pre><code class="language-php">final class ProductPresenter extends AbstractPresenter
{
    /**
     * @inject
     * @var AnotherDependency
     */
    public $anotherDependency;
}</code></pre>
<p><em class="fas fa-fw fa-2x fa-check text-success"></em></p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\NoInjectOnFinalRule</code> rule.</p>
<p><br></p>
<p>That's it for today. Try the rule one by one and run PHPStan to see how it helps your project:</p>
<pre><code class="language-bash">composer require symplify/phpstan-rules --dev</code></pre>
<p><br></p>
<p>Happy coding!</p>

            <br>

            <div class="row mb-5 mt-5">
                <div class="col-12 mb-5">
                                                                <a href="/blog/2021/01/18/4-ways-symplify-makes-working-with-symfony-more-fun" class="d-block pt-4 pb-4 pl-4 pr-4 btn btn-success btn-wrappable">
                            <em class="fas fa-fw fa-forward"></em>
                            <strong>Read Next</strong>
                            <br>
                            <span class="text-bigger">
                                4 Ways Symplify makes Working With Symfony More Fun
                            </span>
                        </a>
                                    </div>
            </div>

            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <script src="/assets/js/jquery-3.3.1.slim.min.js"></script>
<script src="/assets/js/cleaning-lady-checklist.js"></script>

<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

<script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/assets/prism/prism.js"></script>

<script>
    // sortable table
    $('.sortable_table').DataTable({
        // see https://datatables.net/examples/basic_init/filter_only.html
        "searching": false,
        "paging": false,
        "info": false,
        "order": [[1, "desc"]],
        // see https://datatables.net/examples/advanced_init/sort_direction_control.html
        "aoColumns": [
            null,
            { "orderSequence": [ "desc", "asc" ] },
            { "orderSequence": [ "desc", "asc" ] },
            { "orderSequence": [ "desc", "asc" ] }
        ]
    });
</script>

<div class="text-center mt-5" id="footer">
    <p class="mt-2">
        Open-source is my life. Does it help yours? You can <a href="https://github.com/sponsors/TomasVotruba">Sponsor Me</a> &nbsp;
        <em class="fas fa-heart text-danger fa-lg"></em>

        &nbsp;
        <span class="pl-2 pr-2">•</span>
        &nbsp;

        See <a href="/archive">Post Archive</a>

        &nbsp;
        <span class="pl-2 pr-2">•</span>
        &nbsp;

        <a href="/rss.xml">Get RSS</a>
    </p>

    <br>

    <p>
        Did you know my daily focus goes to <strong>turning working with legacy code into joy</strong>?

        <br>

        With awesome <a href="https://getrector.org/">Instant Refactoring tool called Rector</a>.
    </p>
</div>
    </body>
</html>

        <meta property="og:type" content="article" />
    <meta property="og:title" content="4 PHPStan Rules that Bring Order to Nette Injects" />
    <meta property="og:description" content="Do you have at least one `@inject` property or `inject*()` method in your Nette project? If no, stop reading and have fun with another post.


If you do, you probably have some internal rules where what and how to use them and where to avoid them. But how do you keep order?
" />
    <meta property="og:url" content="/blog/2021/01/25/4-phpstan-rule-that-bring-order-to-nette-injects" />

        <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@votrubaT">
    <meta name="twitter:title" content="4 PHPStan Rules that Bring Order to Nette Injects" />
    <meta name="twitter:description" content="Do you have at least one `@inject` property or `inject*()` method in your Nette project? If no, stop reading and have fun with another post.


If you do, you probably have some internal rules where what and how to use them and where to avoid them. But how do you keep order?
" />
